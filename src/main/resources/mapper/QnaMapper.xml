<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heydoctor.app.mapper.QnaMapper">
    <sql id="search">
        <if test="search.type != null and !search.type.equals('')">
            <trim prefix="AND(" prefixOverrides="OR" suffix=")">
                <foreach item="type" collection="search.types">
                    <trim prefix="OR">
                        <choose>
                            <when test="type=='t'.toString()">
                                POST_TITLE LIKE '%'||#{search.keyword}||'%'
                            </when>
                            <when test="type=='c'.toString()">
                                POST_CONTENT LIKE '%'||#{search.keyword}||'%'
                            </when>
                            <when test="type=='w'.toString()">
                                MEMBER_NAME LIKE '%'||#{search.keyword}||'%'
                            </when>
                        </choose>
                    </trim>
                </foreach>
            </trim>
        </if>
    </sql>

    <select id="selectList" resultType="qnaDTO">
        SELECT QNA_ID, USER_ID, QNA_TITLE, QNA_CONTENT, QNA_REGISTER_DATETIME, QNA_IS_PUBLIC, USER_NAME
        FROM
        (
        SELECT ROWNUM R, Q.QNA_ID, U.USER_ID, QNA_TITLE, QNA_CONTENT, QNA_REGISTER_DATETIME, QNA_IS_PUBLIC, U.USER_NAME
        FROM TBL_USER U JOIN TBL_QNA Q
        <![CDATA[
            ON U.USER_ID = Q.USER_ID AND
            ROWNUM <= #{pagination.page} * #{pagination.rowCount}
        ]]>
        <include refid="search"/>
        ORDER BY
        <choose>
            <when test="search.order == 'popular'">
                READ_COUNT
            </when>
            <otherwise>
                QNA_ID
            </otherwise>
        </choose>
        ASC
        <![CDATA[
        ) Q WHERE R > (#{pagination.page} - 1) * #{pagination.rowCount}
        ]]>
    </select>

    <select id="selectOne" resultType="qnaDTO">
        SELECT QNA_ID, Q.USER_ID, QNA_TITLE, QNA_CONTENT, QNA_REGISTER_DATETIME, QNA_IS_PUBLIC,
         U.USER_NAME
        FROM TBL_USER U JOIN TBL_QNA Q
        ON U.USER_ID = Q.USER_ID
        <![CDATA[AND QNA_ID = #{qnaId}]]>
    </select>

    <insert id="insert">
        INSERT INTO TBL_QNA (
                QNA_ID, USER_ID, QNA_TITLE, QNA_CONTENT,
                QNA_IS_PUBLIC
        )
        VALUES (
                SEQ_QNA.NEXTVAL, #{userId}, #{qnaTitle}, #{qnaContent},
                #{qnaIsPublic}
        )
    </insert>

    <delete id="delete">
        DELETE FROM TBL_QNA WHERE QNA_ID = #{qnaId, jdbcType=VARCHAR}
    </delete>

    <select id="selectCountOfPost" resultType="_int">
        SELECT COUNT(Q.USER_ID)
        FROM TBL_USER U JOIN TBL_QNA Q
        ON Q.USER_ID = U.USER_ID
--         <include refid="search"/>
    </select>
</mapper>